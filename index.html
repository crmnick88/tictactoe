<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <title>Tic Tac Toe - Multiplayer</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
        }

        .screen {
            max-width: 500px;
            width: 100%;
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .title {
            text-align: center;
            font-size: clamp(28px, 8vw, 42px);
            font-weight: bold;
            background: linear-gradient(135deg, #e94560 0%, #00d9ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
        }

        .btn {
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid transparent;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #16213e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            border-color: #00d9ff;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #e94560 0%, #ff6b88 100%);
        }

        .btn-small {
            padding: 12px;
            font-size: 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(0, 217, 255, 0.2);
        }

        .back-btn {
            background: none;
            border: none;
            color: #00d9ff;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }

        .room-code-display {
            background: #0f3460;
            border: 2px solid #00d9ff;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin: 30px 0;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
        }

        .room-code {
            font-family: 'Courier New', monospace;
            font-size: 36px;
            letter-spacing: 8px;
            color: #00d9ff;
            font-weight: bold;
        }

        .code-input-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 30px 0;
        }

        .code-input {
            width: 50px;
            height: 60px;
            font-size: 28px;
            text-align: center;
            background: #16213e;
            border: 2px solid #00d9ff;
            border-radius: 8px;
            color: white;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }

        .spinner {
            text-align: center;
            font-size: 48px;
            animation: spin 1s linear infinite;
            color: #00d9ff;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .status-text {
            text-align: center;
            font-size: 20px;
            color: #a0a0a0;
            margin: 20px 0;
        }

        .game-info {
            background: rgba(22, 33, 62, 0.5);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .connection-status {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        .status-dot.connected { background: #00ff88; }
        .status-dot.disconnected { background: #e94560; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .scoreboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(22, 33, 62, 0.5);
            padding: 20px;
            border-radius: 15px;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 14px;
            color: #a0a0a0;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 32px;
            font-weight: bold;
            color: #ffffff;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 30px;
        }

        .cell {
            aspect-ratio: 1;
            background: #16213e;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: clamp(40px, 12vw, 70px);
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-family: 'Arial Black', Arial, sans-serif;
        }

        .cell:hover:not(.taken):not(.disabled) {
            background: #1a4d7a;
            transform: scale(1.05);
        }

        .cell.taken, .cell.disabled {
            cursor: not-allowed;
        }

        .cell.winning {
            background: linear-gradient(135deg, #00d9ff 0%, #00ff88 100%);
            animation: celebrate 0.6s ease-in-out;
        }

        .cell .mark {
            animation: markAppear 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .cell .x {
            color: #e94560;
            text-shadow: 0 0 20px rgba(233, 69, 96, 0.6);
        }

        .cell .o {
            color: #00d9ff;
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.6);
        }

        @keyframes markAppear {
            0% {
                opacity: 0;
                transform: scale(0) rotate(-180deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05) rotate(-5deg); }
            75% { transform: scale(1.05) rotate(5deg); }
        }

        .turn-indicator {
            text-align: center;
            font-size: clamp(18px, 5vw, 24px);
            font-weight: 600;
            padding: 15px;
            background: rgba(22, 33, 62, 0.5);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .turn-indicator.your-turn {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .turn-indicator.opponent-turn {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
        }

        .turn-indicator.win {
            background: rgba(0, 255, 136, 0.3);
            color: #00ff88;
            animation: pulse 1s ease-in-out infinite;
        }

        .turn-indicator.loss {
            background: rgba(233, 69, 96, 0.3);
            color: #e94560;
        }

        .error-message {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body>
    <!-- Mode Selection Screen -->
    <div id="modeScreen" class="screen active">
        <h1 class="title">TIC TAC TOE</h1>
        <button class="btn" onclick="app.showScreen('aiGame')">
            <span>נ₪–</span> Play vs Computer
        </button>
        <button class="btn" onclick="app.showScreen('multiplayerLobby')">
            <span>נ‘¥</span> Play with Friend
        </button>
    </div>

    <!-- Multiplayer Lobby -->
    <div id="multiplayerLobby" class="screen">
        <div class="header">
            <button class="back-btn" onclick="app.showScreen('modeScreen')">ג†</button>
            <h2>MULTIPLAYER</h2>
            <div style="width: 40px;"></div>
        </div>
        <button class="btn btn-primary" onclick="app.createGame()">Create Game</button>
        <button class="btn" onclick="app.showScreen('joinGame')">Join Game</button>
    </div>

    <!-- Create Game / Waiting Room -->
    <div id="waitingRoom" class="screen">
        <div class="header">
            <button class="back-btn" onclick="app.cancelGame()">ג•</button>
            <h2>WAITING ROOM</h2>
            <div style="width: 40px;"></div>
        </div>
        <div class="status-text">Waiting for opponent...</div>
        <div class="spinner">ג³</div>
        <div class="room-code-display">
            <div style="font-size: 14px; color: #a0a0a0; margin-bottom: 10px;">Room Code</div>
            <div class="room-code" id="roomCodeDisplay">------</div>
        </div>
        <button class="btn btn-small" onclick="app.copyCode()">נ“‹ Copy Code</button>
        <button class="btn btn-small" onclick="app.shareCode()">נ”— Share</button>
        <div class="status-text" style="font-size: 16px; margin-top: 20px;">
            Share this code with your friend!
        </div>
    </div>

    <!-- Join Game -->
    <div id="joinGame" class="screen">
        <div class="header">
            <button class="back-btn" onclick="app.showScreen('multiplayerLobby')">ג†</button>
            <h2>JOIN GAME</h2>
            <div style="width: 40px;"></div>
        </div>
        <div class="status-text">Enter Room Code:</div>
        <div class="code-input-container" id="codeInputs">
            <input type="text" class="code-input" maxlength="1" data-index="0">
            <input type="text" class="code-input" maxlength="1" data-index="1">
            <input type="text" class="code-input" maxlength="1" data-index="2">
            <input type="text" class="code-input" maxlength="1" data-index="3">
            <input type="text" class="code-input" maxlength="1" data-index="4">
            <input type="text" class="code-input" maxlength="1" data-index="5">
        </div>
        <div class="error-message" id="joinError"></div>
        <button class="btn btn-primary" onclick="app.joinGameByCode()">Join Game</button>
    </div>

    <!-- AI Game -->
    <div id="aiGame" class="screen">
        <div class="header">
            <button class="back-btn" onclick="app.showScreen('modeScreen')">ג†</button>
            <h2>VS COMPUTER</h2>
            <div style="width: 40px;"></div>
        </div>
        
        <div class="scoreboard">
            <div class="score-item">
                <div class="score-label">Wins</div>
                <div class="score-value" id="winsAI">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">Draws</div>
                <div class="score-value" id="drawsAI">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">Losses</div>
                <div class="score-value" id="lossesAI">0</div>
            </div>
        </div>

        <div class="board" id="boardAI">
            <button class="cell" data-index="0"></button>
            <button class="cell" data-index="1"></button>
            <button class="cell" data-index="2"></button>
            <button class="cell" data-index="3"></button>
            <button class="cell" data-index="4"></button>
            <button class="cell" data-index="5"></button>
            <button class="cell" data-index="6"></button>
            <button class="cell" data-index="7"></button>
            <button class="cell" data-index="8"></button>
        </div>

        <button class="btn btn-primary" onclick="app.newAIGame()">New Game</button>
        <div class="turn-indicator your-turn" id="statusAI">Your Turn!</div>
    </div>

    <!-- Multiplayer Game -->
    <div id="multiplayerGame" class="screen">
        <div class="header">
            <button class="back-btn" onclick="app.leaveMultiplayerGame()">ג†</button>
            <h2>MULTIPLAYER</h2>
            <div style="width: 40px;"></div>
        </div>

        <div class="game-info">
            <div class="player-info">
                <div>You: <span id="yourSymbol">X</span></div>
                <div>Friend: <span id="opponentSymbol">O</span></div>
            </div>
            <div class="connection-status">
                <span class="status-dot connected"></span>
                <span id="connectionText">Connected</span>
            </div>
        </div>

        <div class="board" id="boardMulti">
            <button class="cell" data-index="0"></button>
            <button class="cell" data-index="1"></button>
            <button class="cell" data-index="2"></button>
            <button class="cell" data-index="3"></button>
            <button class="cell" data-index="4"></button>
            <button class="cell" data-index="5"></button>
            <button class="cell" data-index="6"></button>
            <button class="cell" data-index="7"></button>
            <button class="cell" data-index="8"></button>
        </div>

        <button class="btn btn-primary" onclick="app.rematch()" id="rematchBtn" style="display: none;">Play Again</button>
        <div class="turn-indicator" id="statusMulti">Waiting...</div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjT492XYgotOa0e4oO-DWtZeAXJx5g93Q",
            authDomain: "tictactoe-4a13b.firebaseapp.com",
            databaseURL: "https://tictactoe-4a13b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tictactoe-4a13b",
            storageBucket: "tictactoe-4a13b.firebasestorage.app",
            messagingSenderId: "1043102184042",
            appId: "1:1043102184042:web:5e1a3a7680f29416f7d013"
        };

        // Initialize Firebase
        let firebaseApp, database;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            // Fallback mode without Firebase
        }

        // Main App
        const app = {
            currentScreen: 'modeScreen',
            gameMode: null, // 'ai' or 'multiplayer'
            roomCode: null,
            playerSymbol: null,
            isMyTurn: false,
            gameRef: null,
            
            // AI Game State
            aiGameState: {
                board: Array(9).fill(null),
                gameActive: true,
                scores: { wins: 0, draws: 0, losses: 0 }
            },

            // Multiplayer Game State
            multiGameState: {
                board: Array(9).fill(null),
                gameActive: true
            },

            winningCombinations: [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ],

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
                this.currentScreen = screenId;
            },

            // ===== MULTIPLAYER FUNCTIONS =====

            generateRoomCode() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let code = '';
                for (let i = 0; i < 6; i++) {
                    code += chars[Math.floor(Math.random() * chars.length)];
                }
                return code;
            },

            async createGame() {
                if (!database) {
                    alert('Multiplayer requires internet connection and Firebase setup');
                    return;
                }

                this.roomCode = this.generateRoomCode();
                this.playerSymbol = 'X';
                this.gameMode = 'multiplayer';

                // Create game in Firebase
                this.gameRef = database.ref('games/' + this.roomCode);
                await this.gameRef.set({
                    board: Array(9).fill(null),
                    players: {
                        X: 'waiting',
                        O: null
                    },
                    currentTurn: 'X',
                    status: 'waiting',
                    createdAt: Date.now()
                });

                document.getElementById('roomCodeDisplay').textContent = this.roomCode;
                this.showScreen('waitingRoom');

                // Listen for opponent
                this.gameRef.child('players/O').on('value', (snapshot) => {
                    if (snapshot.val()) {
                        this.startMultiplayerGame();
                    }
                });
            },

            copyCode() {
                if (this.roomCode) {
                    navigator.clipboard.writeText(this.roomCode);
                    alert('Code copied: ' + this.roomCode);
                }
            },

            async shareCode() {
                if (this.roomCode && navigator.share) {
                    try {
                        await navigator.share({
                            title: 'Tic Tac Toe',
                            text: `Join my game! Room code: ${this.roomCode}`
                        });
                    } catch (err) {
                        this.copyCode();
                    }
                } else {
                    this.copyCode();
                }
            },

            cancelGame() {
                if (this.gameRef) {
                    this.gameRef.remove();
                }
                this.showScreen('multiplayerLobby');
            },

            async joinGameByCode() {
                const inputs = document.querySelectorAll('.code-input');
                const code = Array.from(inputs).map(i => i.value.toUpperCase()).join('');
                
                if (code.length !== 6) {
                    this.showError('joinError', 'Please enter a 6-character code');
                    return;
                }

                if (!database) {
                    this.showError('joinError', 'Multiplayer requires internet connection');
                    return;
                }

                this.roomCode = code;
                this.playerSymbol = 'O';
                this.gameMode = 'multiplayer';

                // Check if game exists
                const gameRef = database.ref('games/' + code);
                const snapshot = await gameRef.once('value');
                
                if (!snapshot.exists()) {
                    this.showError('joinError', 'Room not found. Check the code.');
                    return;
                }

                const gameData = snapshot.val();
                if (gameData.players.O) {
                    this.showError('joinError', 'Room is full.');
                    return;
                }

                // Join game
                this.gameRef = gameRef;
                await gameRef.child('players/O').set('connected');
                this.startMultiplayerGame();
            },

            showError(elementId, message) {
                const errorEl = document.getElementById(elementId);
                errorEl.textContent = message;
                errorEl.classList.add('show');
                setTimeout(() => errorEl.classList.remove('show'), 3000);
            },

            startMultiplayerGame() {
                console.log('Starting multiplayer game, player:', this.playerSymbol);
                
                // Update game status to active
                if (this.playerSymbol === 'O') {
                    this.gameRef.update({ status: 'active' });
                }
                
                this.showScreen('multiplayerGame');
                document.getElementById('yourSymbol').textContent = this.playerSymbol;
                document.getElementById('opponentSymbol').textContent = this.playerSymbol === 'X' ? 'O' : 'X';

                // Listen to game state
                this.gameRef.on('value', (snapshot) => {
                    const gameData = snapshot.val();
                    if (!gameData) {
                        console.error('No game data received');
                        return;
                    }

                    console.log('Game data received:', gameData);

                    if (gameData.board && Array.isArray(gameData.board)) {
                        this.updateMultiplayerBoard(gameData.board);
                    }
                    
                    this.isMyTurn = (gameData.currentTurn === this.playerSymbol);
                    this.updateTurnIndicator();
                    
                    if (gameData.status === 'finished') {
                        this.handleMultiplayerGameEnd(gameData);
                    }
                });
            },

            updateMultiplayerBoard(board) {
                if (!board || !Array.isArray(board)) {
                    console.error('Invalid board data:', board);
                    return;
                }
                
                const cells = document.querySelectorAll('#boardMulti .cell');
                cells.forEach((cell, index) => {
                    const value = board[index];
                    if (value) {
                        const className = value === 'X' ? 'x' : 'o';
                        cell.innerHTML = `<span class="mark ${className}">${value}</span>`;
                        cell.classList.add('taken');
                    } else {
                        cell.innerHTML = '';
                        cell.classList.remove('taken', 'x', 'o');
                    }
                    
                    cell.classList.toggle('disabled', !this.isMyTurn || value !== null);
                });
            },

            updateTurnIndicator() {
                const indicator = document.getElementById('statusMulti');
                if (this.isMyTurn) {
                    indicator.textContent = 'נ¢ Your Turn!';
                    indicator.className = 'turn-indicator your-turn';
                } else {
                    indicator.textContent = 'ג³ Opponent\'s turn...';
                    indicator.className = 'turn-indicator opponent-turn';
                }
            },

            async makeMultiplayerMove(index) {
                console.log('makeMultiplayerMove called', index, 'isMyTurn:', this.isMyTurn);
                
                if (!this.isMyTurn) {
                    console.log('Not your turn');
                    return;
                }

                if (!this.gameRef) {
                    console.error('No game reference');
                    return;
                }

                try {
                    const snapshot = await this.gameRef.once('value');
                    const gameData = snapshot.val();
                    
                    if (!gameData) {
                        console.error('No game data');
                        return;
                    }

                    if (!gameData.board || !Array.isArray(gameData.board)) {
                        console.error('Invalid board data');
                        return;
                    }
                    
                    if (gameData.board[index] !== null) {
                        console.log('Cell already taken');
                        return;
                    }

                    const newBoard = [...gameData.board];
                    newBoard[index] = this.playerSymbol;

                    const winner = this.checkWinner(newBoard);
                    const isDraw = newBoard.every(cell => cell !== null);

                    const updates = {
                        board: newBoard,
                        currentTurn: this.playerSymbol === 'X' ? 'O' : 'X'
                    };

                    if (winner) {
                        updates.status = 'finished';
                        updates.winner = winner.winner;
                        updates.winningCombo = winner.combo;
                    } else if (isDraw) {
                        updates.status = 'finished';
                        updates.winner = 'draw';
                    }

                    await this.gameRef.update(updates);
                    console.log('Move completed successfully');
                } catch (error) {
                    console.error('Error making move:', error);
                }
            },

            handleMultiplayerGameEnd(gameData) {
                const indicator = document.getElementById('statusMulti');
                document.getElementById('rematchBtn').style.display = 'block';

                if (gameData.winner === 'draw') {
                    indicator.textContent = 'Draw!';
                    indicator.className = 'turn-indicator';
                } else if (gameData.winner === this.playerSymbol) {
                    indicator.textContent = 'נ‰ You Win! נ‰';
                    indicator.className = 'turn-indicator win';
                    this.highlightWinningCells('#boardMulti', gameData.winningCombo);
                } else {
                    indicator.textContent = 'Opponent Wins';
                    indicator.className = 'turn-indicator loss';
                    this.highlightWinningCells('#boardMulti', gameData.winningCombo);
                }
            },

            async rematch() {
                if (!this.gameRef) return;

                await this.gameRef.update({
                    board: Array(9).fill(null),
                    currentTurn: 'X',
                    status: 'active',
                    winner: null,
                    winningCombo: null
                });

                document.getElementById('rematchBtn').style.display = 'none';
                const cells = document.querySelectorAll('#boardMulti .cell');
                cells.forEach(cell => {
                    cell.classList.remove('winning');
                });
            },

            leaveMultiplayerGame() {
                if (this.gameRef) {
                    this.gameRef.off();
                    if (this.playerSymbol === 'X') {
                        this.gameRef.remove();
                    }
                }
                this.showScreen('modeScreen');
            },

            // ===== AI GAME FUNCTIONS =====

            newAIGame() {
                this.aiGameState.board = Array(9).fill(null);
                this.aiGameState.gameActive = true;

                const cells = document.querySelectorAll('#boardAI .cell');
                cells.forEach(cell => {
                    cell.textContent = '';
                    cell.classList.remove('taken', 'disabled', 'winning', 'x', 'o');
                });

                document.getElementById('statusAI').textContent = 'Your Turn!';
                document.getElementById('statusAI').className = 'turn-indicator your-turn';
            },

            makeAIMove(index) {
                if (!this.aiGameState.gameActive || this.aiGameState.board[index] !== null) {
                    return;
                }

                // Player move
                this.aiGameState.board[index] = 'X';
                const cell = document.querySelectorAll('#boardAI .cell')[index];
                cell.innerHTML = '<span class="mark x">X</span>';
                cell.classList.add('taken');

                const winResult = this.checkWinner(this.aiGameState.board);
                if (winResult) {
                    this.endAIGame(winResult);
                    return;
                }

                if (this.aiGameState.board.every(c => c !== null)) {
                    this.endAIGame({});
                    return;
                }

                // AI turn
                document.getElementById('statusAI').textContent = 'Computer thinking...';
                document.getElementById('statusAI').className = 'turn-indicator opponent-turn';
                
                setTimeout(() => {
                    this.computerMove();
                }, 500);
            },

            computerMove() {
                let move = this.findWinningMove(this.aiGameState.board, 'O') || 
                           this.findWinningMove(this.aiGameState.board, 'X') ||
                           (this.aiGameState.board[4] === null ? 4 : null);

                if (move === null) {
                    const corners = [0, 2, 6, 8].filter(i => this.aiGameState.board[i] === null);
                    if (corners.length > 0) {
                        move = corners[Math.floor(Math.random() * corners.length)];
                    }
                }

                if (move === null) {
                    const available = this.aiGameState.board.map((v, i) => v === null ? i : null).filter(v => v !== null);
                    move = available[Math.floor(Math.random() * available.length)];
                }

                if (move !== null) {
                    this.aiGameState.board[move] = 'O';
                    const cell = document.querySelectorAll('#boardAI .cell')[move];
                    cell.innerHTML = '<span class="mark o">O</span>';
                    cell.classList.add('taken');

                    const winResult = this.checkWinner(this.aiGameState.board);
                    if (winResult) {
                        this.endAIGame(winResult);
                        return;
                    }

                    if (this.aiGameState.board.every(c => c !== null)) {
                        this.endAIGame({});
                        return;
                    }

                    document.getElementById('statusAI').textContent = 'Your Turn!';
                    document.getElementById('statusAI').className = 'turn-indicator your-turn';
                }
            },

            endAIGame(result) {
                this.aiGameState.gameActive = false;
                const status = document.getElementById('statusAI');

                if (result.winner) {
                    this.highlightWinningCells('#boardAI', result.combo);
                    if (result.winner === 'X') {
                        this.aiGameState.scores.wins++;
                        document.getElementById('winsAI').textContent = this.aiGameState.scores.wins;
                        status.textContent = 'נ‰ You Win! נ‰';
                        status.className = 'turn-indicator win';
                    } else {
                        this.aiGameState.scores.losses++;
                        document.getElementById('lossesAI').textContent = this.aiGameState.scores.losses;
                        status.textContent = 'Computer Wins';
                        status.className = 'turn-indicator loss';
                    }
                } else {
                    this.aiGameState.scores.draws++;
                    document.getElementById('drawsAI').textContent = this.aiGameState.scores.draws;
                    status.textContent = 'Draw!';
                    status.className = 'turn-indicator';
                }
            },

            // ===== SHARED GAME LOGIC =====

            checkWinner(board) {
                for (let combo of this.winningCombinations) {
                    const [a, b, c] = combo;
                    if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                        return { winner: board[a], combo };
                    }
                }
                return null;
            },

            findWinningMove(board, player) {
                for (let combo of this.winningCombinations) {
                    const [a, b, c] = combo;
                    const line = [board[a], board[b], board[c]];
                    if (line.filter(cell => cell === player).length === 2 &&
                        line.filter(cell => cell === null).length === 1) {
                        if (board[a] === null) return a;
                        if (board[b] === null) return b;
                        if (board[c] === null) return c;
                    }
                }
                return null;
            },

            highlightWinningCells(boardSelector, combo) {
                if (!combo) return;
                const cells = document.querySelectorAll(boardSelector + ' .cell');
                combo.forEach(index => {
                    cells[index].classList.add('winning');
                });
            }
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // AI Game board clicks
            document.querySelectorAll('#boardAI .cell').forEach((cell, index) => {
                cell.addEventListener('click', () => app.makeAIMove(index));
            });

            // Multiplayer board clicks
            document.querySelectorAll('#boardMulti .cell').forEach((cell, index) => {
                cell.addEventListener('click', () => app.makeMultiplayerMove(index));
            });

            // Code input handling
            const codeInputs = document.querySelectorAll('.code-input');
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    const value = e.target.value.toUpperCase();
                    e.target.value = value;
                    if (value.length === 1 && index < 5) {
                        codeInputs[index + 1].focus();
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });
            });

            // Load AI scores
            const saved = localStorage.getItem('tictactoe_ai_scores');
            if (saved) {
                try {
                    app.aiGameState.scores = JSON.parse(saved);
                    document.getElementById('winsAI').textContent = app.aiGameState.scores.wins;
                    document.getElementById('drawsAI').textContent = app.aiGameState.scores.draws;
                    document.getElementById('lossesAI').textContent = app.aiGameState.scores.losses;
                } catch (e) {}
            }
        });

        // Save AI scores on page unload
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('tictactoe_ai_scores', JSON.stringify(app.aiGameState.scores));
        });
    </script>
</body>
</html>
